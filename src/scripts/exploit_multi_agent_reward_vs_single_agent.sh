#!/bin/bash

SCRIPTS_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
export SRC_DIR=$(realpath $(dirname ${SCRIPTS_DIR}))
export PYTHON_SCRIPTS_DIR=$(realpath ${SRC_DIR}/tfm_sc2)
export BASE_MODELS_DIR=$(realpath $(dirname ${SRC_DIR})/models)
export AGENT_TYPE="multi"
export AGENT_ALGORITHM="dqn"
export REWARD_METHOD="reward"
MODELS_DIR="${BASE_MODELS_DIR}/05"

# Game Manager
export AGENT_SUBTYPE="game_manager"
export BASE_MODEL_ID=multi_dqn_${AGENT_SUBTYPE}
export MAP=Simple64
export EXPLOIT_EPISODES=100
export LOG_SUFFIX="_01"

AGENT_KEY="${AGENT_TYPE}.${AGENT_ALGORITHM}.${AGENT_SUBTYPE}"
MODEL_ID="${BASE_MODEL_ID}_${REWARD_METHOD}"
MODEL_DIR="${MODELS_DIR}/${MODEL_ID}"

SINGLE_AGENT_MODEL_ID="single_dqn_${REWARD_METHOD}"

SINGLE_AGENT_MODEL_DIR="${MODELS_DIR}/${SINGLE_AGENT_MODEL_ID}"

echo "Exploiting Game Manager on ${MAP}"
touch ${MODEL_DIR}/_01_exploit_start_${EXPLOIT_EPISODES}_ep

python ${PYTHON_SCRIPTS_DIR}/runner.py \
    --agent_key "${AGENT_KEY}" \
    --map_name "${MAP}" \
    --num_episodes ${EXPLOIT_EPISODES} \
    --log_file ${MODEL_DIR}/exploit${LOG_SUFFIX}.log \
    --model_id ${MODEL_ID} \
    --models_path ${MODELS_DIR} \
    --exploit \
    --agent2_path ${SINGLE_AGENT_MODEL_DIR} \
    --reward_method ${REWARD_METHOD} 2>&1 | tee ${MODEL_DIR}/${MAP}${LOG_SUFFIX}.log
touch ${MODEL_DIR}/_02_exploit_done_${EXPLOIT_EPISODES}_ep
